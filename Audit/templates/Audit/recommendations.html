{% extends 'Audit/audit_base.html' %}
{% load static %}
{% load get_item %}

{% block load %}
<link rel="stylesheet" href="{% static 'audit\audit.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
    <div class="d-flex align-items-center gap-3">
        {% if back %}<a class="btn btn-outline-primary" href="{% if back.parent %}{% url 'audit:recommendations' pk=back.parent.pk %}{% else %}{% url 'audit:recommendations' %}{% endif %}">Back</a>{% endif %}
        <h3 class="m-0 ml-3">Recomendations{% if back %} - {{back.name}}{% endif %}</h3>
    </div>
    <div>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="collapse navbar-collapse">
                <div class="navbar-nav">
                    {% for subcategory in subcategories %}
                    <a href="{% url 'audit:recommendations' pk=subcategory.pk %}" class="nav-item nav-link nav-highlight text-dark border-right border-left" href="#">{{subcategory.name}}</a>
                    {% endfor %}
                </div>
            </div>
        </nav>
    </div>
    <div class="d-flex flex-column gap-0">
        <div class="h5 rounded-top bg-secondary p-2 mb-0 text-light">Legend</div>
        <div class="rounded-bottom bg-light p-2">
            <table>
                <tr class="d-block d-sm-inline-flex me-2">
                    <td class="d-flex align-items-center">
                        <span class="progress-pill" style="background-color: #ca9a96"></span> - Does not match required questions <span class="infoButton">ⓘ<span>Does not match the excpected required question answers</span></span>
                    </td>
                </tr>
                <tr class="d-block d-sm-inline-flex me-2">
                    <td class="d-flex align-items-center">
                        <span class="progress-pill" style="background-color: #ffb5af"></span> - Does not match questions <span class="infoButton">ⓘ<span>Does not match the expected question answers</span></span>
                    </td>
                </tr>
                <tr class="d-block d-sm-inline-flex me-2">
                    <td class="d-flex align-items-center">
                        <span class="progress-pill" style="background-color: #eeeeee"></span> - Unanswered <span class="infoButton">ⓘ<span>Has no answer associated with the question</span></span>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    {% if conditions %}
    <div class="d-flex flex-column mt-4">
        <div class="h5 rounded-top bg-secondary p-2 mb-0 text-light">Recomendations</div>
        <table class="table">
            <thead>
                <tr>
                    <th>Question</th>
                    <th class="text-center" style="width: 150px;">Answer</th>
                    <th class="text-center" style="width: 200px;">Expected</th>
                    <th class="text-center" style="width: 150px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for condition in conditions %}
                {% with correct_val=correct_answers|get_item:condition %}
                <tr style="{% if correct_val == False %}{% if not condition.required %}background-color: #ffb5af{% else %}background-color: #ca9a96{% endif %}{% elif correct_val == None %}background-color: #eeeeee{% endif %}">
                    <td class="{% if question.mandatory.0 %} mandatory{% endif %}">{{ condition.question.question }}</td>
                    <td class="text-center">
                        {% if answers|get_item:condition %}
                            {% if condition.question.answerType == QUESTION_TYPE.YES_NO %}
                                {% if answers|get_item:condition == 'true' %}Yes{% else %}No{% endif %}
                            {% else %}
                                {{answers|get_item:condition}}
                            {% endif %}
                        {% else %}---{% endif %}</td>
                    <td class="text-center">
                        {% if condition.question.answerType == QUESTION_TYPE.YES_NO %}
                            {% if not condition.inverse %}Yes{% else %}No{% endif %}
                        {% elif condition.question.answerType == QUESTION_TYPE.LIKERTA %}
                            {% if not condition.inverse %}
                                {% if condition.min %}Min: {{ condition.question.likerta|get_item:condition.min }}{% endif %}<br>
                                {% if condition.max %}Max: {{ condition.question.likerta|get_item:condition.max }}{% endif %}
                            {% else %}
                                {% if condition.min %}Less then: {{ condition.question.likerta|get_item:condition.min }}{% endif %}<br>
                                {% if condition.max %}More then: {{ condition.question.likerta|get_item:condition.max }}{% endif %}
                            {% endif %}
                        {% elif condition.question.answerType == QUESTION_TYPE.INTERVAL %}
                            {% if not condition.inverse %}
                                {% if condition.min %}Min: {{ condition.min }}{% endif %}<br>
                                {% if condition.max %}Max: {{ condition.max }}{% endif %}
                            {% else %}
                                {% if condition.min %}Less then: {{ condition.min }}{% endif %}<br>
                                {% if condition.max %}More then: {{ condition.max }}{% endif %}
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if condition.type in request.user.usercategory.category_set %}<a class="form-buttons p-2 px-4" href="{% url 'audit:question_form' pk=condition.question.subtheme.first.pk %}">Change</a>{% endif %}
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="d-flex flex-column mt-4">
        <div class="h5 rounded-top bg-secondary p-2 mb-0 text-light">Recomendations</div>
        <div class="rounded-bottom bg-light w-100 p-2">
            Select subcategory to see recomendations
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}
